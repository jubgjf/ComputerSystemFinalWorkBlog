<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第3章 编译 | Guan Jiannan 的计算机系统大作业博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/ComputerSystemFinalWorkBlog/assets/css/0.styles.16f4c5d5.css" as="style"><link rel="preload" href="/ComputerSystemFinalWorkBlog/assets/js/app.1b5451d3.js" as="script"><link rel="preload" href="/ComputerSystemFinalWorkBlog/assets/js/2.a04b7fc9.js" as="script"><link rel="preload" href="/ComputerSystemFinalWorkBlog/assets/js/12.f7378424.js" as="script"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/10.8c04925c.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/11.3b6f4125.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/13.3f64a882.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/14.0dc1b3d6.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/15.145cf089.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/16.529c9f0a.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/17.e0fb3384.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/18.68e4c5ab.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/3.5219c653.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/4.0ed284d6.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/5.8b64aaec.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/6.744a911e.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/7.efae4d63.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/8.58d5c346.js"><link rel="prefetch" href="/ComputerSystemFinalWorkBlog/assets/js/9.32b0a8f2.js">
    <link rel="stylesheet" href="/ComputerSystemFinalWorkBlog/assets/css/0.styles.16f4c5d5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ComputerSystemFinalWorkBlog/" class="home-link router-link-active"><!----> <span class="site-name">Guan Jiannan 的计算机系统大作业博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>程序人生 - Hello’s P2P</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/ComputerSystemFinalWorkBlog/" aria-current="page" class="sidebar-link">大作业说明</a></li><li><a href="/ComputerSystemFinalWorkBlog/abstract.html" class="sidebar-link">摘要</a></li><li><a href="/ComputerSystemFinalWorkBlog/ch1.html" class="sidebar-link">第1章 概述</a></li><li><a href="/ComputerSystemFinalWorkBlog/ch2.html" class="sidebar-link">第2章 预处理</a></li><li><a href="/ComputerSystemFinalWorkBlog/ch3.html" aria-current="page" class="active sidebar-link">第3章 编译</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ComputerSystemFinalWorkBlog/ch3.html#编译的概念与作用" class="sidebar-link">编译的概念与作用</a></li><li class="sidebar-sub-header"><a href="/ComputerSystemFinalWorkBlog/ch3.html#在ubuntu下编译的命令" class="sidebar-link">在Ubuntu下编译的命令</a></li><li class="sidebar-sub-header"><a href="/ComputerSystemFinalWorkBlog/ch3.html#hello的编译结果解析" class="sidebar-link">Hello的编译结果解析</a></li><li class="sidebar-sub-header"><a href="/ComputerSystemFinalWorkBlog/ch3.html#本章小结" class="sidebar-link">本章小结</a></li></ul></li><li><a href="/ComputerSystemFinalWorkBlog/ch4.html" class="sidebar-link">第4章 汇编</a></li><li><a href="/ComputerSystemFinalWorkBlog/ch5.html" class="sidebar-link">第5章 链接</a></li><li><a href="/ComputerSystemFinalWorkBlog/ch6.html" class="sidebar-link">第6章 hello 进程管理</a></li><li><a href="/ComputerSystemFinalWorkBlog/ch7.html" class="sidebar-link">第7章 hello 存储管理</a></li><li><a href="/ComputerSystemFinalWorkBlog/ch8.html" class="sidebar-link">第8章 hello IO 管理</a></li><li><a href="/ComputerSystemFinalWorkBlog/conclusion.html" class="sidebar-link">结论</a></li><li><a href="/ComputerSystemFinalWorkBlog/appendix.html" class="sidebar-link">附件</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第3章-编译"><a href="#第3章-编译" class="header-anchor">#</a> 第3章 编译</h1> <h2 id="编译的概念与作用"><a href="#编译的概念与作用" class="header-anchor">#</a> 编译的概念与作用</h2> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <p>编译是利用编译器（此实验为gcc）从源程序产生目标程序的过程。</p> <h3 id="作用"><a href="#作用" class="header-anchor">#</a> 作用</h3> <p>将便于人编写、阅读、维护的高级计算机语言所写作的源代码（此实验为预处理后的.i文件），翻译为低阶机器语言的过程（此处为汇编语言）。</p> <h2 id="在ubuntu下编译的命令"><a href="#在ubuntu下编译的命令" class="header-anchor">#</a> 在Ubuntu下编译的命令</h2> <p>使用gcc -S进行编译，生成汇编代码，如图</p> <p><img src="image009.png" alt="图 8 汇编"></p> <p>查看汇编代码的内容，示例如下</p> <p><img src="image010.png" alt="图 9 编译结果示例"></p> <h2 id="hello的编译结果解析"><a href="#hello的编译结果解析" class="header-anchor">#</a> Hello的编译结果解析</h2> <h3 id="hello-s概述"><a href="#hello-s概述" class="header-anchor">#</a> hello.s概述</h3> <ul><li>.align 声明对指令或者数据的存放地址进行对齐的方式，本处为8</li> <li>.LC0 标签下有一个string类型</li> <li>.LC1 标签下是第二个string类型</li> <li>.globl 声明全局变量 main</li> <li>.type 用来指定是函数类型或是对象类型 本处main @function</li></ul> <h3 id="数据类型"><a href="#数据类型" class="header-anchor">#</a> 数据类型</h3> <ol><li>int型整数</li></ol> <p>main函数中使用的int型变量有参数argc和循环变量i。</p> <p>a) int argc：作为main函数第一个参数传入，这个值是后面参数argv指针数组的数组元素个数</p> <p>b) int i：编译器将局部变量i存储在了栈空间中，本处编译器将 i 存储在栈上空间-4(%rbp)中， i 占据了栈中的 4B，对-4(%rbp)进行操作。</p> <ol start="2"><li>string字符串</li></ol> <p>如图 10 hello.s开头可见，有两个字符串分别被标记为.LC0和.LC1，其中.LC0对应的是main中的&quot;用法： Hello 学号 姓名 秒数！\n&quot;，而.LC1对应的是&quot;Hello %s %s\n&quot;。
由于采用了UTF-8编码，一个汉字对应3个字节，所以在汇编代码中.LC0字符串对应关系如下：</p> <table><thead><tr><th style="text-align:center;">汉字</th> <th style="text-align:center;">编码</th></tr></thead> <tbody><tr><td style="text-align:center;">用</td> <td style="text-align:center;">\347\224\250</td></tr> <tr><td style="text-align:center;">法</td> <td style="text-align:center;">\346\263\225</td></tr> <tr><td style="text-align:center;">学</td> <td style="text-align:center;">\345\255\246</td></tr> <tr><td style="text-align:center;">号</td> <td style="text-align:center;">\345\217\267</td></tr> <tr><td style="text-align:center;">姓</td> <td style="text-align:center;">\345\247\223</td></tr> <tr><td style="text-align:center;">名</td> <td style="text-align:center;">\345\220\215</td></tr> <tr><td style="text-align:center;">秒</td> <td style="text-align:center;">\347\247\222</td></tr> <tr><td style="text-align:center;">数</td> <td style="text-align:center;">\346\225\260</td></tr> <tr><td style="text-align:center;">！（中文叹号）</td> <td style="text-align:center;">\357\274\201</td></tr></tbody></table> <p>这两个字符串都是只读的，位于.rodata只读数据节中。</p> <ol start="3"><li>数组</li></ol> <p>main函数中的数组是char *argv[] ，指的是命令行参数。</p> <p>argv 每个指针元素 char*大小 8B，argv 指针指向已经分配好的、一片存放着字符指针的连续空间，起始地址为 argv，main 函数中访问数组元素argv[1]，argv[2]时，按照起始地址 argv 大小 8B 计算数据地址取数据，在hello.s 中，引用两次(%rax)（两次 rax 为argv[1]和 argv[2]的地址）取出其值。</p> <h3 id="赋值操作"><a href="#赋值操作" class="header-anchor">#</a> 赋值操作</h3> <p>在汇编中，赋值操作一般使用mov指令。将变量i初始化为0的指令如下：</p> <p><img src="image012.png" alt="图 11 将i赋值为0"></p> <p>mov指令后会有表示数据大小的后缀，包括q、l、w、b，具体解释如下：</p> <table><thead><tr><th style="text-align:center;">后缀</th> <th style="text-align:center;">含义</th></tr></thead> <tbody><tr><td style="text-align:center;">b</td> <td style="text-align:center;">1个字节（byte）</td></tr> <tr><td style="text-align:center;">w</td> <td style="text-align:center;">2个字节（word）</td></tr> <tr><td style="text-align:center;">l</td> <td style="text-align:center;">4个字节（long）</td></tr> <tr><td style="text-align:center;">q</td> <td style="text-align:center;">8个字节（quadword）</td></tr></tbody></table> <p>由于i是int类型的变量，是4字节的，所以指令使用了movl对i进行赋值。</p> <h3 id="类型转换"><a href="#类型转换" class="header-anchor">#</a> 类型转换</h3> <ol><li>从int转换为float时，不会发生溢出，但由于int使用32位存储整数，而float中只有23位用于存储整数部分，所以转换后可能有数据被舍入。</li> <li>从int或 float转换为double时，因为double的有效位数足够多，所以能保留精确值。</li> <li>从double转换为float和int时，可能发生溢出，此外，由于有效位数变少，故可能被舍入。</li> <li>从float 或double转换为int时，因为int没有小数部分，所以数据可能会向0方向被截断</li></ol> <p>当前代码中没有隐式的类型转换。</p> <h3 id="算术操作"><a href="#算术操作" class="header-anchor">#</a> 算术操作</h3> <p>常用算术操作如下表：</p> <table><thead><tr><th style="text-align:center;">指令</th> <th style="text-align:center;">解释</th></tr></thead> <tbody><tr><td style="text-align:center;">INC reg/mem</td> <td style="text-align:center;">reg/mem += 1</td></tr> <tr><td style="text-align:center;">DEC reg/mem</td> <td style="text-align:center;">reg/mem += 1</td></tr> <tr><td style="text-align:center;">ADD src, dst</td> <td style="text-align:center;">dst += src</td></tr> <tr><td style="text-align:center;">SHL imm, reg/mem</td> <td style="text-align:center;">reg/mem 逻辑左移imm位</td></tr> <tr><td style="text-align:center;">SHR imm, reg/mem</td> <td style="text-align:center;">reg/mem 逻辑右移imm位</td></tr> <tr><td style="text-align:center;">SAR imm, reg/mem</td> <td style="text-align:center;">reg/mem 算数右移imm位</td></tr></tbody></table> <p>程序中，对循环变量i增加1的指令如下图：</p> <p><img src="image013.png" alt="图 12 add指令"></p> <p>和mov指令相似，由于i是int型的4字节数据类型，所以add也要加后缀l。</p> <h3 id="比较操作"><a href="#比较操作" class="header-anchor">#</a> 比较操作</h3> <p>最常用的比较操作是组合使用cmp src1， src2指令和jXX tag指令。cmp指令首先计算src2 – src1，从而获得条件码，之后jXX指令根据条件码决定进行跳转到tag。
例如，hello.c中比较argc是否为4：</p> <p><img src="image014.png" alt="图 13 比较argc和4"></p> <p>在汇编中，使用cmpl：</p> <p><img src="image015.png" alt="图 14 cmpl比较argc和4"></p> <p>该指令的流程是：计算argc – 4，若结果是0，则满足je跳转条件（条件码为ZERO/EQUAL），则控制跳转到.L2位置；否则，控制流正常线性执行。</p> <p>相似地，test src1， src2指令也可以用于跳转。</p> <p>控制转移包括if、switch、while三大类。</p> <ol><li><p>if条件判断：此部分见3.3.6 比较操作。</p></li> <li><p>switch分支：当前程序没有用到switch操作。</p></li></ol> <p>但是需要注意的是，switch的原理是根据跳转表进行跳转。</p> <ol start="3"><li>while循环</li></ol> <p>程序中用到了for循环，与while循环类似。</p> <p>三种常用循环转为汇编的结构如下：</p> <p>do-while：</p> <div class="language- extra-class"><pre class="language-text"><code>Loop：
    Body
    If(Test)
        Goto Loop
</code></pre></div><p>While第一种实现：</p> <div class="language- extra-class"><pre class="language-text"><code>Goto Test
Loop：
    Body
    If(Test)
        Goto Loop
</code></pre></div><p>While第二种实现：</p> <div class="language- extra-class"><pre class="language-text"><code>If(!Test)
    Goto Done
Loop：
    Body
    If(Test)
        Goto Loop
Done：
</code></pre></div><p>for：</p> <div class="language- extra-class"><pre class="language-text"><code>Init
Goto Test
Loop：
    Body
    Update
    If(Test)
        Goto Loop
</code></pre></div><h3 id="函数"><a href="#函数" class="header-anchor">#</a> 函数</h3> <p>程序中涉及函数操作的有：</p> <ol><li>main 函数：</li></ol> <p>a) 调用</p> <p>通过 call指令跳转到main。call 指令将下一条指令的地址压栈，然后跳转到 main 函数，如图：</p> <p><img src="image016.png" alt="图 15 调用main函数"></p> <p>b) 传递参数</p> <p>分别使用%rdi （第一个参数）和%rsi （第二个参数）存储argc和argv。Main函数通过对两个寄存器进行操作，实现获取参数。</p> <p><img src="image017.png" alt="图 16 main获取参数"></p> <p>c) 返回</p> <p>返回值储存在%eax中。设置%eax为0，也就是return 0。
注意到main最后两个指令ret和leave：</p> <p><img src="image018.png" alt="图 17 ret和leave"></p> <p>leave指令相当于mov %rbp， %rsp和pop %rbp。即用于回退栈帧，将两个与栈帧有关的寄存器回退到调用main之前的状态。
ret指令相当于pop %rip，即弹出跳转到栈顶元素所指示的地址进行执行。由于call时是将下一条指令的地址压栈，所以此时弹栈就可以回到之前的位置继续执行。</p> <ol start="2"><li>printf 函数：</li></ol> <p>a)	传递参数：第一次 printf 将%rdi 设置为(&quot;用法： Hello 学号 姓名 秒数！\n&quot;)字符串的首地址。第二次 printf 设置%rdi 为“Hello %s %s\n”的首地址，设置%rsi 为 argv[1]，%rdx 为 argv[2]。</p> <p>b)	执行：注意printf是一种IO操作，在其内部会使用系统调用syscall。详细说明见第6章 hello进程管理。</p> <p>atoi函数，sleep 函数，getchar 函数，exit 函数与上述函数类似，不再重复说明。需要注意exit同样也使用了系统调用_exit。</p> <h2 id="本章小结"><a href="#本章小结" class="header-anchor">#</a> 本章小结</h2> <p>本章通过对于hello.i进行编译，获得汇编文件hello.s，结合编译的概念及作用分析了编译对文本.i文件的相应处理，详细地阐述了数据、赋值、类型转换、算术操作、逻辑/位操作、关系操作、数组/指针/结构操作、控制转移、函数操作的过程，并对结果进行了相应的解析。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">9/25/2021, 4:41:50 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ComputerSystemFinalWorkBlog/ch2.html" class="prev">
        第2章 预处理
      </a></span> <span class="next"><a href="/ComputerSystemFinalWorkBlog/ch4.html">
        第4章 汇编
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/ComputerSystemFinalWorkBlog/assets/js/app.1b5451d3.js" defer></script><script src="/ComputerSystemFinalWorkBlog/assets/js/2.a04b7fc9.js" defer></script><script src="/ComputerSystemFinalWorkBlog/assets/js/12.f7378424.js" defer></script>
  </body>
</html>
